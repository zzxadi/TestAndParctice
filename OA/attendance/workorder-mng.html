<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>填写工单</title>
<link type="text/css" href="/css/base.css" rel="stylesheet" />
<link type="text/css" href="/css/module.css" rel="stylesheet" />
<link type="text/css" href="/css/buyer.css" rel="stylesheet" />
<link href="/css/timepicker.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="/js/jquery.min.js"></script>
<script type="text/javascript" src="/js/common.js"></script>
<script type="text/javascript" src="/js/module.js"></script>
<script type="text/javascript" src="/js/timepicker.js"></script>
<script type="text/javascript">
var GLOBAL_PARAM = {
	g_boxId : $.trim(getUrlParam("boxId")),
	operateLogo : $.trim(getUrlParam("operateLogo")),
	leaveParamFlag : false,
	overtimeParamFlag : false,
	forgetParamFlag : false
};
/*保存工单*/
function saveWorkOrder(operateFlag){
	var param = '',method = '';
	if(operateFlag == 'leaveTrip'){
		param = leaveTripParam();
		method = 'addLeaveTrip';
	}else if(operateFlag == 'overtimeRequest'){
		param = overtimeRequestParam();
		method = 'addOvertimeRequest';
	}else if(operateFlag == 'forgetCard'){
		param = forgetCardParam();
		method = 'addForgetCard';
	}
	if(!GLOBAL_PARAM.leaveParamFlag && !GLOBAL_PARAM.overtimeParamFlag && !GLOBAL_PARAM.forgetParamFlag){
		$('#prompt_'+operateFlag).text('请将信息填写完整再提交.');
		return;
	}else{
		$('#prompt_'+operateFlag).text('');
	}
	ajax({
		url:'/php/action/WorkOrderAction.php',
		type: 'post',
		data: 'method='+method+'&'+param,
		dataType: 'json',
		async: true,
		cache: false,
		timeout: 30000,
		error: function(){},
		success: function(data){
			if(data.msgCode != 1){ return; }
			$('#prompt_'+operateFlag).html('操作成功.');
			setTimeout(function(){
				if(parent){ parent.getWorkOrderList(); parent.getWorkOrderList(1,'forget_'); }
				close_box();
			},1000);
		}
	});
}
function leaveTripParam(){
	var auditId = $('#leaveAuditId').val();
	var leaveTimeBegin = $('#leaveTimeBegin').val();
	var leaveTimeEnd = $('#leaveTimeEnd').val();
	var leaveTotalTime = $('#leaveTotalTime').val();
	var reason = $('input[name=reason]:checked').val();
	var remark = $('#remark').val();
	
	if(auditId && leaveTimeBegin && leaveTimeEnd && leaveTotalTime && reason){ GLOBAL_PARAM.overtimeParamFlag = true; }
	
	var param = [];
	if(reason == 10){
		var otherReason = $('#otherReason').val();
		if(!otherReason){ GLOBAL_PARAM.overtimeParamFlag = true; }
		param.push('otherReason='+otherReason);
	}
	param.push('type=2');
	param.push('auditId='+auditId);
	param.push('timeBegin='+leaveTimeBegin);
	param.push('timeEnd='+leaveTimeEnd);
	param.push('totalTime='+leaveTotalTime);
	param.push('reason='+reason);
	param.push('remark='+remark);
	
	return param.join('&');
}
function overtimeRequestParam(){
	var auditId = $('#overtimeAuditId').val();
	var overtimeReason = $('#overtimeReason').val();
	var overtimeBegin = $('#overtimeBegin').val();
	var overtimeEnd = $('#overtimeEnd').val();
	var overtimeTotalTime = $('#overtimeTotalTime').val();
	
	if(auditId && overtimeReason && overtimeBegin && overtimeEnd && overtimeTotalTime){ GLOBAL_PARAM.forgetParamFlag = true; }
	
	var param = [];
	param.push('type=1');
	param.push('auditId='+auditId);
	param.push('remark='+overtimeReason);
	param.push('timeBegin='+overtimeBegin);
	param.push('timeEnd='+overtimeEnd);
	param.push('totalTime='+overtimeTotalTime);
	
	return param.join('&');
}
function forgetCardParam(){
	var auditId = $('#forgetCardAuditId').val();
	var forgetCardTime = $('#forgetCardTime').val();
	var forgetType = $('input[name=forgetCard]:checked').val();
	
	var arriveTimeHour = $('#arriveTimeHour').val();
	var arriveTimeMin = $('#arriveTimeMin').val();
	var leaveTimeHour = $('#leaveTimeHour').val();
	var leaveTimeMin = $('#leaveTimeMin').val();

	var inTime = forgetType == 1 ? (arriveTimeHour+':'+arriveTimeMin) : (forgetType == 2 ? (leaveTimeHour+':'+leaveTimeMin) : '');
	var forgetCardRemark = $('#forgetCardRemark').val();
	
	if(auditId && forgetCardTime && forgetType && inTime){ GLOBAL_PARAM.leaveParamFlag = true; }
	
	if(forgetType == 1){
		if(!arriveTimeHour || !arriveTimeMin){ GLOBAL_PARAM.leaveParamFlag = false; }
	}else if(forgetType == 2){
		if(!leaveTimeHour || !leaveTimeMin){ GLOBAL_PARAM.leaveParamFlag = false; }
	}
	
	var param = [];
	param.push('type='+forgetType);
	param.push('auditId='+auditId);
	param.push('forgetTime='+forgetCardTime);
	param.push('inTime='+inTime);
	param.push('remark='+forgetCardRemark);
	
	return param.join('&');
}
/*关闭弹框*/
function close_box(){
	if(GLOBAL_PARAM.g_boxId!=''&&parent&&parent.closeBox)parent.closeBox(GLOBAL_PARAM.g_boxId);
}
/*加载时间控件*/
function loadTimeInput(){
	$('#leaveTimeBegin').datetimepicker({
		dateFormat: 'yy-mm-dd',timeFormat:'HH:mm:00',constrainInput:true,
		showButtonPanel:false,showTime:false
	});
	$('#leaveTimeEnd').datetimepicker({
		dateFormat: 'yy-mm-dd',timeFormat:'HH:mm:00',constrainInput:true,
		showButtonPanel:false,showTime:false
	});
	$('#overtimeBegin').datetimepicker({
		dateFormat: 'yy-mm-dd',timeFormat:'HH:mm:00',constrainInput:true,
		showButtonPanel:false,showTime:false
	});
	$('#overtimeEnd').datetimepicker({
		dateFormat: 'yy-mm-dd',timeFormat:'HH:mm:00',constrainInput:true,
		showButtonPanel:false,showTime:false
	});
	$('#forgetCardTime').datepicker({dateFormat: 'yy-mm-dd',constrainInput:true});
}
function loadInitEvent(){
	//DIV加载
	if(GLOBAL_PARAM.operateLogo == 'leaveTrip'){
		$('.workorder_leave').show();
	}else if(GLOBAL_PARAM.operateLogo == 'overtimeRequest'){
		$('.workorder_overtime').show();
	}else if(GLOBAL_PARAM.operateLogo == 'forgetCard'){
		$('.workorder_forget_card').show();
	}
	//选择时间(上午/下午)
	$('input[name=forgetCard]').click(function(){
		if($(this).val()==1){
			 $('#arriveTime')[0].checked = true;
			 $('#leaveTime')[0].checked = false;
			 $('#arriveTimeHour')[0].disabled = false;
			 $('#arriveTimeMin')[0].disabled = false;
			 $('#leaveTimeHour').val('')[0].disabled = true;
			 $('#leaveTimeMin').val('')[0].disabled = true;
		}else if($(this).val()==2){
			$('#leaveTime')[0].checked = true;
			$('#arriveTime')[0].checked = false; 
			$('#leaveTimeHour')[0].disabled = false;
			$('#leaveTimeMin')[0].disabled = false;
			$('#arriveTimeHour').val('')[0].disabled = true;
			$('#arriveTimeMin').val('')[0].disabled = true;
		}
	});
	$('input[name=reason]').click(function(){
		if($(this).val() == 10){ $('#otherReason').show(); }
		else{ $('#otherReason').hide(); }
	});
}
/*获得所有管理者*/
function getApproveManger(){
	ajax({
		url:"/php/action/ApproveOrderInfo.php",
		type:'post',
		data:'method=managerList',
		dataType:'json',
		async:false,
		cache:false,
		timeout:30000,
		error:function(){},
		success:getApproveMangerSuccess
	});	
};
function getApproveMangerSuccess(data){
	if(parseInt(data.msgCode)==3){
		locationHref('../index.html');
	}else if(parseInt(data.msgCode)==4){
		showBox("提示",data.msg,"alert");	
		return;
	}
	var code=data.entity.list;
	var html="";
	if(code.length >= 1){
		for(var i=0,j=code.length;i<j;i++){
			html+='<option value="'+code[i].id+'">'+code[i].userName+'</option>';
		}
	}else{
		html+='<option>暂无审批人</option>';	
	}
	if(GLOBAL_PARAM.operateLogo == 'leaveTrip'){
		$('#leaveAuditId').html(html);
	}else if(GLOBAL_PARAM.operateLogo == 'overtimeRequest'){
		$('#overtimeAuditId').html(html);
	}else if(GLOBAL_PARAM.operateLogo == 'forgetCard'){
		$('#forgetCardAuditId').html(html);
	}
}
/*加载页面信息*/
$(function(){
	loadTimeInput();
	loadInitEvent();
	getApproveManger();
});
</script>
</head>

<body>
<div class="workorder_mng">
<!-- 请假/出差单开始 -->
   <div class="workorder_leave hide">
    <dl>
    	<dt><span class="cred">*</span>审批人：</dt>
    	<dd>
    		<select id="leaveAuditId" class="txt grid-12"></select>
    	</dd>
    </dl>
   	<dl>
   		<dt><span class="cred">*</span>离岗时间：</dt>
    	<dd><input type="text" id="leaveTimeBegin" class="txt grid-12" />
			至
			<input type="text" id="leaveTimeEnd" class="txt grid-12" />
			<span>总时间<input type="text" id="leaveTotalTime" class="input_total_time" />小时</span>
			&nbsp;&nbsp;<span id="leaveTimeErr" class="cred"></span>
		</dd>
	</dl>
	<dl>
	   	<dt><span class="cred">*</span>事由：</dt>
	   	<dd>
   			<input type="radio" value="1" id="reason_1" name="reason"><label for="reason_1">事假</label>
   			<input type="radio" value="2" id="reason_2" name="reason"><label for="reason_2">病假</label>
   			<input type="radio" value="3" id="reason_3" name="reason"><label for="reason_3">调休</label>
   			<input type="radio" value="4" id="reason_4" name="reason"><label for="reason_4">婚嫁</label>
   			<input type="radio" value="5" id="reason_5" name="reason"><label for="reason_5">产假</label>
   			<input type="radio" value="6" id="reason_6" name="reason"><label for="reason_6">计生假</label>
   			<input type="radio" value="7" id="reason_7" name="reason"><label for="reason_7">年休假</label>
   			<input type="radio" value="8" id="reason_8" name="reason"><label for="reason_8">丧假</label><br/>
   			<input type="radio" value="9" id="reason_9" name="reason"><label for="reason_9">工伤假</label>
   			<input type="radio" value="10" id="reason_10" name="reason"><label for="reason_10">其他假</label>
   			<input type="text" id="otherReason" class="txt grid-12 hide" />
   		</dd>
   </dl>
   <dl>
      <dt>备注：</dt>
      <dd><textarea type="text" id="remark" class="txt grid-45" rows="2"></textarea></dd>
   </dl>
   <p class="workorder_save_button">
   	<input id="saveButton" type="button" onclick="saveWorkOrder('leaveTrip')" class="mybtn" value="提交" />
   	<input id="resetButton" type="button" onclick="close_box()" class="mybtn btn_cancel" value="取消" />
   	<span id="prompt_leaveTrip" class="cred"></span>
   </p>
   </div>
<!-- 请假/出差单结束 -->
<!-- 加班申请单开始 -->          
   <div class="workorder_overtime hide">
    <dl>
    	<dt><span class="cred">*</span>审批人：</dt>
    	<dd>
    		<select id="overtimeAuditId" class="txt grid-12"></select>
    	</dd>
    </dl>
   	<dl>
      <dt><span class="cred">*</span>申请加班原因：</dt>
      <dd><textarea type="text" id="overtimeReason" class="txt grid-45" rows="2"></textarea></dd>
   	</dl>
   	<dl>
   		<dt><span class="cred">*</span>申请加班时间：</dt>
    	<dd><input type="text" id="overtimeBegin" class="txt grid-12" />
			至
			<input type="text" id="overtimeEnd" class="txt grid-12" />
			<span>总时间<input type="text" id="overtimeTotalTime" class="input_total_time" />小时</span>
			&nbsp;&nbsp;<span id="overtimeErr" class="cred"></span>
		</dd>
	</dl>
	<p class="workorder_save_button">
   		<input id="saveButton" type="button" onclick="saveWorkOrder('overtimeRequest')" class="mybtn" value="提交" />
   		<input id="resetButton" type="button" onclick="close_box()" class="mybtn btn_cancel" value="取消" />
   		<span id="prompt_overtimeRequest" class="cred"></span>
   	</p>
   </div>
<!-- 加班申请单结束 -->
<!-- 忘打卡开始 -->          
   <div class="workorder_forget_card hide">
    <dl>
    	<dt><span class="cred">*</span>审批人：</dt>
    	<dd>
    		<select id="forgetCardAuditId" class="txt grid-12"></select>
    	</dd>
    </dl>
   	<dl>
   		<dt><span class="cred">*</span>忘刷卡时间：</dt>
    	<dd><input type="text" id="forgetCardTime" class="txt grid-12" />
    		<input type="radio" value="1" id="morning" name="forgetCard"><label for="morning">上午</label>
    		<input type="radio" value="2" id="afternoon" name="forgetCard"><label for="afternoon">下午</label>
			&nbsp;&nbsp;<span id="overtimeErr" class="cred"></span>
		</dd>
	</dl>
   	<dl>
   		<dt><span class="cred">*</span>情况说明：</dt>
    	<dd>
    		<input type="checkbox" disabled="disabled" value="1" id="arriveTime" name="condition"><label for="arriveTime">到岗时间：</label>
    		<input type="text" class="input_total_time" id="arriveTimeHour" onkeyup="this.value=this.value.replace(/\D/g,'')" disabled="disabled" /> 时
    		<input type="text" class="input_total_time" id="arriveTimeMin" onkeyup="this.value=this.value.replace(/\D/g,'')" disabled="disabled" /> 分
    		<input type="checkbox" disabled="disabled" value="2" id="leaveTime" name="condition"><label for="leaveTime">离岗时间：</label>
    		<input type="text" class="input_total_time" id="leaveTimeHour" onkeyup="this.value=this.value.replace(/\D/g,'')" disabled="disabled"/> 时
    		<input type="text" class="input_total_time" id="leaveTimeMin" onkeyup="this.value=this.value.replace(/\D/g,'')" disabled="disabled"/> 分
			&nbsp;&nbsp;<span id="overtimeErr" class="cred"></span>
		</dd>
	</dl>
	<dl>
      <dt>备注：</dt>
      <dd><textarea type="text" id="forgetCardRemark" class="txt grid-45" rows="2"></textarea></dd>
   	</dl>
   	<p class="workorder_save_button">
   		<input id="saveButton" type="button" onclick="saveWorkOrder('forgetCard')" class="mybtn" value="提交" />
   		<input id="resetButton" type="button" onclick="close_box()" class="mybtn btn_cancel" value="取消" />
   		<span id="prompt_forgetCard" class="cred"></span>
   	</p>
   </div>
<!-- 忘打卡结束 -->
</div>
<div class="workorder_instruction">
	<h4>说明：</h4>
	<dl><dt>1、</dt><dd>员工请假1天以内（含1天），由部门经理审批；请假1天以上3天（含）以下的，由分管领导审批；请假超过3天的由总经理审批；</dd></dl>
	<dl><dt>2、</dt><dd>经理级人员请假1天（含）以下的由分管领导审批，1天以上的由总经理审批；</dd></dl>
	<dl><dt>3、</dt><dd>公司管理层的请假由总经理审批；</dd></dl>
	<dl><dt>4、</dt><dd>除事假、病假、出差外，其他假期须由人力资源部审核后再报相关领导审批，避免与相关规定冲突；</dd></dl>
	<dl><dt>5、</dt><dd>此表在完成审批流程后由申请人交人力资源部据以考勤。</dd></dl>
</div>
</body>
</html>