<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>人员管理</title>
	<link rel="stylesheet" type="text/css" href="/css/base.css">
	<link rel="stylesheet" type="text/css" href="/css/module.css">
	<link rel="stylesheet" type="text/css" href="/css/buyer.css">
	<link rel="stylesheet" type="text/css" href="/css/timepicker.css">
	<script type="text/javascript" src="/js/common.js"></script>
	<script type="text/javascript" src="/js/module.js"></script>
	<script type="text/javascript" src="/js/jquery.min.js"></script>
	<script type="text/javascript" src="/js/timepicker.js"></script>
	<script type="text/javascript">
		$(document).ready(function() {
			loadHtml("headerId","/include/header.html");
			loadHtml("left_menu_content","/include/leftmenu.html");
			loadHtml("footerId","/include/footer.html");
			selectNavigation("userInfo");//菜单高亮

			bindEvent();
			$('#indTime').datepicker({dateFormat: 'yy-mm-dd',constrainInput:true,maxDate: new Date(),onClose: validate.validateIndTime,});
			var id = getUrlParam('id');
			if(id){
				setData(id);
			}
		});

		function bindEvent(){
			$('.user_form').on('blur', '#username', validate.validateUsername)
						   .on('blur', '#loginname', validate.validateLoginname)
						   .on('blur', '#mobile', validate.validateMobile)
						   .on('blur', '#email', validate.validateEmail)
						   .on('blur', '#position', validate.validatePosition)
						   .on('click', '#submit', submitForm)
						   .on('click', '#reset', resetForm);
		}

		var validate = (function(){
			return {
				validateUsername : function(){
					var username = $.trim($('#username').val()),
						$usernameMsg = $('#usernameMsg');

					if(!username){
						$usernameMsg.html('姓名不能为空').attr('class', 'error');
						return false;
					}
					$usernameMsg.html('').attr('class', 'right');
					return true;
				},
				validateLoginname : function(){
					var loginname = $.trim($('#loginname').val()),
						$loginnameMsg = $('#loginnameMsg');

					if(!loginname){
						$loginnameMsg.html('登录名不能为空').attr('class', 'error');
						return false;
					}
					else if(!checkLoginnameMul() && !$.data(document, 'id')){
						$loginnameMsg.html('登录名已经被使用').attr('class', 'error');
						return false;
					}
					$loginnameMsg.html('').attr('class', 'right');
					return true;
				},
				validateMobile : function(){
					var mobile = $.trim($('#mobile').val()),
						$mobileMsg = $('#mobileMsg'),
						mobileReg = /^13\d{9}|15[012356789]\d{8}|18\d{9}$/;

					if(!mobileReg.test(mobile)){
						$mobileMsg.html('手机号码格式不正确').attr('class', 'error');
						return false;
					}
					$mobileMsg.html('').attr('class', 'right');
					return true;
				},
				validateEmail : function(){
					var email = $.trim($('#email').val()),
						$emailMsg = $('#emailMsg');

					if(!email){
						$emailMsg.html('电子邮箱不能为空').attr('class', 'error');
						return false;
					}
					$emailMsg.html('').attr('class', 'right');
					return true;					
				},
				validatePosition : function(){
					var position = $.trim($('#position').val()),
						$positionMsg = $('#positionMsg');

					if(!position){
						$positionMsg.html('职位不能为空').attr('class', 'error');
						return false;
					}
					$positionMsg.html('').attr('class', 'right');
					return true;					
				},
				validateIndTime : function(){
					var indTime = $.trim($('#indTime').val()),
						$indTimeMsg = $('#indTimeMsg');

					if(!indTime){
						$indTimeMsg.html('入职时间不能为空').attr('class', 'error');
						return false;
					}
					$indTimeMsg.html('').attr('class', 'right');
					return true;					
				},				
			}				
		})();

		function validateData(){
			if(!validate.validateUsername()){
				locationHash('username');
				return false;
			}
			if(!validate.validateLoginname()){
				locationHash('loginname');
				return false;
			}
			if(!validate.validateMobile()){
				locationHash('mobile');
				return false;
			}
			if(!validate.validateEmail()){
				locationHash('email');
				return false;
			}
			if(!validate.validatePosition()){
				locationHash('position');
				return false;
			}
			if(!validate.validateIndTime()){
				locationHash('indTime');
				return false;
			}
			return true;
		}

		function setData(id){
			var param = [];
				param.push('id='+id),
				param.push('method=getUserById');
			$.data(document, 'id', id);
			ajax({
				url:'/php/action/UserInfo.php',
				type:'post',//非必须.默认get
				data:param.join('&'),
				dataType:'json',//非必须.默认text
				success:function(data){
					var record = data.entity.list[0];
					$('#roleId').val(record.roleId);
					$('#username').val(record.userName);
					$('#loginname').val(record.loginName);
					$('#mobile').val(record.mobile);
					$('#email').val(record.email);
					$('#dept').val(record.departmentType)
					$('#position').val(record.positionName);
					$('#indTime').val(record.inductionTime);
				}
			})
		}

		function submitForm(){
			if(!validateData()){
				return false;
			}
			var param = [];
			param.push('roleId='+$('#roleId').val());
			param.push('username='+$('#username').val());
			param.push('loginname='+$('#loginname').val());
			param.push('mobile='+$('#mobile').val());
			param.push('email='+$('#email').val());
			param.push('sex='+$('input[name="sex"]:checked').val());
			param.push('dept='+$('#dept').val());
			param.push('position='+$('#position').val());
			param.push('indTime='+$('#indTime').val());
			if($.data(document, 'id')){
				param.push('method=doModify');
				param.push('id='+$.data(document, 'id'));
			}
			else{
				param.push('method=doAdd');
			}
			ajax({
				url:'/php/action/UserInfo.php',
				type:'post',//非必须.默认get
				data:param.join('&'),
				dataType:'json',//非必须.默认text
				success:function(data){
					if(data.msgCode==1){
						showBox('提示', '操作成功', 'alert', function(){
							 $('#reset').click();
						});
					}
				}
			})
		}

		function checkLoginnameMul(){
			var param = [], 
				pass ={ state: false};

			param.push('loginname='+$('#loginname').val());
			param.push('method=checkLoginnameMul');
			ajax({
				url:'/php/action/LoginAction.php',
				type:'post',//非必须.默认get
				data:param.join('&'),
				async:false,
				dataType:'json',//非必须.默认text
				success:function(data, pass){
					if(data.msgCode==1){
						pass.state = true;
					}
					else{
						pass.state = false;
					}
				}
			}, pass)
			return pass.state;
		}

		function resetForm(){
			$('.user_form dd span').html('').attr('class', '');
		}
	</script>
</head>
<body>
<div id="headerId"></div>
<div class="bread"><a href="/">首页</a> &gt; <span>人员管理</span></div>
<div class="main">
	<div class="clearfix">
		<div class="content_box">
			<div class="content">
				<div class="page_title">人员管理</div>
				<div class="page_main">
					<form method="post" class="user_form">
						<dl>
							<dt><em class="cred">*</em>角色：</dt>
							<dd><select class="select" id="roleId">
							<option value="1" selected>普通员工</option>
							<option value="2">管理员</option>
							<option value="5">工单终结者</option>
							<option value="9">超级管理员</option></select></dd>
						</dl>
						<dl>
							<dt><em class="cred">*</em>姓名：</dt>
							<dd><input type="text" name="username" class="txt grid-20" id="username"><span id="usernameMsg"></span></dd>
						</dl>
						<dl>
							<dt><em class="cred">*</em>登录名：</dt>
							<dd><input type="text" name="loginname" class="txt grid-20" id="loginname"><span id="loginnameMsg"></span></dd>
						</dl>
						<dl>
							<dt><em class="cred">*</em>手机号码：</dt>
							<dd><input type="text" name="mobile" class="txt grid-20" id="mobile" maxlength="11"><span id="mobileMsg"></span></dd>
						</dl>
						<dl>
							<dt><em class="cred">*</em>电子邮箱：</dt>
							<dd><input type="text" name="email" class="txt grid-20" id="email"><span id="emailMsg"></span></dd>
						</dl>
						<dl>
							<dt><em class="cred">*</em>性别：</dt>
							<dd><input type="radio" name="sex" value="0" checked id="sex">男&nbsp;&nbsp;<input type="radio" name="sex" value="1">女</dd>
						</dl>
						<dl>
							<dt><em class="cred">*</em>部门：</dt>
							<dd>
							<select class="select" id="dept">
								<option value="1">信息技术部</option>
								<option value="2">人力资源部</option>
								<option value="3">财务部</option>
								<option value="4">市场部</option>
								<option value="5">售后部</option>
								<option value="6">产品部</option>
								<option value="0">无记录</option>
							</select>
							</dd>
						</dl>
						<dl>
							<dt><em class="cred">*</em>职位：</dt>
							<dd><input type="text" name="position" class="txt grid-20" id="position"><span id="positionMsg"></span></dd>
						</dl>
						<dl>
							<dt><em class="cred">*</em>入职时间：</dt>
							<dd><input type="text" class="txt grid-20" id="indTime" /> <span id="indTimeMsg"></span></dd>
						</dl>
						<p><input type="button" class="mybtn btn" value="提交" id="submit"><input type="reset" id="reset" class="btn reset" value="重置"><input type="button" id="goBack" class="btn reset" value="返回" onclick="javascript:history.go(-1);"></p>
					</form>
				</div>
			</div>
		</div>
		<div class="menu">
			<div class="aside">
				<h2 class="aside_title">DIGIONE</h2>
				<div id="left_menu_content"></div>
			</div>
		</div>
	</div>
</div>
<div id="footerId"></div>	
</body>
</html>